<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard Antrean Logistik</title>
    <style>
      :root {
        --primary: #2563eb;       
        --primary-dark: #1d4ed8;
        --bg-body: #f1f5f9;
        --surface: #ffffff;
        --text-main: #0f172a;
        --text-sec: #64748b;
        --border: #e2e8f0;
        
        --badge-bg: #eff6ff; 
        --badge-text: #2563eb;
        --otw-bg: #fff7ed;
        --otw-text: #c2410c;
        --otw-border: #fed7aa;
        
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      }

      * { box-sizing: border-box; }
      
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
        background-color: var(--bg-body);
        color: var(--text-main);
        margin: 0; padding: 1.5rem;
      }

      .container { max-width: 1200px; margin: 0 auto; }

      /* --- USER GUIDE SECTION (BARU) --- */
      .guide-box {
        background: white; border: 1px solid #cbd5e1;
        border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;
        display: flex; flex-direction: column; gap: 0.5rem;
      }
      .guide-title { font-weight: 700; font-size: 0.95rem; color: var(--text-main); display: flex; align-items: center; gap: 6px; }
      .guide-steps {
        display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;
        font-size: 0.85rem; color: var(--text-sec);
      }
      .guide-item { display: flex; gap: 8px; align-items: flex-start; }
      .step-num { 
        background: var(--bg-body); color: var(--text-main); font-weight: 700; 
        width: 20px; height: 20px; border-radius: 50%; 
        display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 0.75rem;
      }
      code { background: #f1f5f9; padding: 2px 4px; border-radius: 4px; font-family: monospace; color: #ef4444; }

      /* HEADER COMPACT */
      .top-header {
        background: white; padding: 1rem 1.25rem;
        border-radius: 10px; box-shadow: var(--shadow-sm);
        display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;
        margin-bottom: 2rem; border: 1px solid var(--border);
      }
      .brand h1 { font-size: 1.25rem; margin: 0; font-weight: 800; color: var(--text-main); }
      .brand p { margin: 2px 0 0; color: var(--text-sec); font-size: 0.8rem; }

      .controls { display: flex; gap: 8px; align-items: center; }
      .file-label {
        display: inline-flex; align-items: center; gap: 6px;
        background: white; border: 1px solid var(--border);
        padding: 8px 12px; border-radius: 6px; font-weight: 500; color: var(--text-sec);
        font-size: 0.85rem; cursor: pointer; transition: all 0.2s;
      }
      .file-label:hover { border-color: var(--primary); color: var(--primary); }
      .file-label.uploaded { border-color: #10b981; color: #10b981; background: #ecfdf5; }
      #fileInput { display: none; }
      
      .btn-primary {
        background: var(--primary); color: white; border: none;
        padding: 8px 16px; border-radius: 6px; font-weight: 600; font-size: 0.85rem;
        cursor: pointer; transition: 0.2s;
      }
      .btn-primary:hover { background: var(--primary-dark); }

      /* SECTIONS & GROUPS */
      .date-section { margin-bottom: 2rem; }
      
      .date-header-pill {
        display: inline-flex; align-items: center; gap: 8px;
        background: #1e293b; color: white; 
        padding: 6px 14px; border-radius: 20px;
        font-weight: 700; font-size: 0.9rem;
        margin-bottom: 1rem;
      }
      .date-header-pill.otw { background: #f97316; }

      .shipping-group {
        background: white; border: 1px solid var(--border); border-radius: 10px;
        padding: 1rem; margin-bottom: 1rem; box-shadow: var(--shadow-sm);
      }

      .shipping-header {
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 0.75rem;
      }
      .shipping-title { font-size: 0.95rem; font-weight: 700; color: var(--primary); display: flex; align-items: center; gap: 6px; }
      .shipping-count { background: var(--bg-body); color: var(--text-sec); padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; }

      /* GRID YANG LEBIH RAPAT */
      .card-grid { 
        display: grid; 
        /* Min 200px agar muat lebih banyak kesamping */
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); 
        gap: 0.75rem; 
      }

      /* CARDS COMPACT */
      .card {
        background: white; border: 1px solid var(--border); border-radius: 8px;
        padding: 0.85rem; position: relative;
        display: flex; flex-direction: column; gap: 4px;
        transition: transform 0.2s, border-color 0.2s;
      }
      .card:hover { border-color: var(--primary); transform: translateY(-2px); box-shadow: var(--shadow-md); }

      .card-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 4px; }
      .queue-label { font-size: 0.7rem; color: var(--text-sec); font-weight: 500; }
      
      .rank-circle {
        width: 22px; height: 22px; /* Lebih kecil */
        background: var(--primary); color: white;
        border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        font-weight: 700; font-size: 0.75rem;
      }

      .card.is-otw { background: #fffaf5; border-color: var(--otw-border); }
      .otw-badge {
        padding: 2px 6px; background: #ffedd5; color: #c2410c; 
        border-radius: 4px; font-size: 0.7rem; font-weight: 700;
      }

      /* Nopol Lebih Kecil tapi Tebal */
      .nopol { font-size: 1.1rem; font-weight: 800; color: var(--text-main); letter-spacing: -0.3px; margin-bottom: 4px; }

      .card-footer { display: flex; align-items: center; gap: 8px; margin-top: auto; }
      .badge-type {
        background: var(--badge-bg); color: var(--badge-text);
        padding: 2px 6px; border-radius: 4px;
        font-size: 0.7rem; font-weight: 700; text-transform: uppercase;
      }
      
      .time-text { font-size: 0.75rem; color: var(--text-sec); font-weight: 500; display: flex; align-items: center; gap: 4px; }

      .empty-state { text-align: center; padding: 3rem; color: var(--text-sec); border: 2px dashed var(--border); border-radius: 10px; }
      .icon-upload { width: 40px; height: 40px; margin-bottom: 0.5rem; opacity: 0.5; }

      #error-banner {
        display: none; background: #fee2e2; color: #b91c1c; padding: 0.75rem;
        border-radius: 6px; margin-bottom: 1rem; border: 1px solid #f87171;
        text-align: center; font-size: 0.9rem; font-weight: 600;
      }
    </style>
  </head>
  <body>

    <div class="container">
      <div id="error-banner"></div>

      <div class="top-header">
        <div class="brand">
          <h1>Dashboard Antrean</h1>
          <p>Sistem Manajemen Sortir Unit Masuk</p>
        </div>
        <div class="controls">
          <label for="fileInput" class="file-label">
            <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
            <span id="fileName">Pilih File...</span>
          </label>
          <input type="file" id="fileInput" accept=".csv, .xlsx" />
          <button id="processButton" class="btn-primary">Proses</button>
        </div>
      </div>

      <div class="guide-box">
        <div class="guide-title">
            <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            Panduan Penggunaan
        </div>
        <div class="guide-steps">
            <div class="guide-item">
                <div class="step-num">1</div>
                <div>Pastikan kolom Excel: <code>No. Polisi</code>, <code>Tipe Shipping</code>, <code>Confirm In</code>.</div>
            </div>
            <div class="guide-item">
                <div class="step-num">2</div>
                <div>Jika kolom <code>Confirm In</code> kosong, unit otomatis masuk grup <b>"Dalam Perjalanan"</b>.</div>
            </div>
            <div class="guide-item">
                <div class="step-num">3</div>
                <div>Nomor antrean (lingkaran biru) diurutkan berdasarkan jam masuk paling awal per tipe.</div>
            </div>
        </div>
      </div>

      <div id="resultArea">
        <div class="empty-state">
           <svg class="icon-upload" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
           <p style="font-size:0.9rem">Silakan Upload File Excel (.xlsx / .csv)</p>
        </div>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" onerror="handleScriptError()"></script>

    <script>
      function handleScriptError() {
        document.getElementById('error-banner').innerHTML = "‚ö†Ô∏è Gagal memuat library Excel. Cek koneksi internet.";
        document.getElementById('error-banner').style.display = 'block';
      }

      const clockIcon = `<svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
      const truckIcon = `<svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 17a2 2 0 11-4 0 2 2 0 014 0zM19 17a2 2 0 11-4 0 2 2 0 014 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1M5 17a2 2 0 012-2v0a2 2 0 10-2 0v0z"></path></svg>`;
      
      let rawData = null;

      document.addEventListener("DOMContentLoaded", () => {
        if (typeof XLSX === 'undefined') handleScriptError();

        const fileInput = document.getElementById("fileInput");
        const fileNameSpan = document.getElementById("fileName");
        const fileLabel = document.querySelector(".file-label");
        const processButton = document.getElementById("processButton");
        const resultArea = document.getElementById("resultArea");

        fileInput.addEventListener("change", (e) => {
           if(e.target.files.length > 0) {
              const name = e.target.files[0].name;
              fileNameSpan.textContent = name.length > 20 ? name.substring(0,18)+"..." : name;
              fileLabel.classList.add("uploaded");
           }
        });

        processButton.addEventListener("click", () => {
            if (typeof XLSX === 'undefined') { alert("Library gagal."); return; }
            const file = fileInput.files[0];
            if (!file) { alert("Pilih file dulu!"); return; }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: "array" });
                    rawData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                    processAndRender(rawData);
                } catch (err) { alert("File error."); }
            };
            reader.readAsArrayBuffer(file);
        });

        function processAndRender(data) {
            if (!data || data.length === 0) return;

            const processed = data.map(row => {
                const rawConfirm = row["Confirm In"];
                let dateStr = "Unknown", timeStr = "00:00", fullTimestamp = "", isOTW = false;

                if (!rawConfirm || rawConfirm.toString().trim() === "") {
                    dateStr = "üöß Sedang Dalam Perjalanan"; timeStr = "-"; isOTW = true; fullTimestamp = "9999"; 
                } else if (typeof rawConfirm === 'string') {
                    let parts = rawConfirm.trim().split(" ");
                    if (parts.length >= 2) { dateStr = parts[0]; timeStr = parts[1]; fullTimestamp = rawConfirm; } 
                    else if (rawConfirm.includes("-") && rawConfirm.length > 10) { 
                        dateStr = rawConfirm.substring(0, 10); timeStr = rawConfirm.substring(11); fullTimestamp = rawConfirm; 
                    } else { dateStr = rawConfirm; fullTimestamp = rawConfirm; }
                }

                return {
                    nopol: row["No. Polisi"] || "Unknown",
                    tipe: row["Tipe Shipping"] || "Gen",
                    dateKey: dateStr, timeDisplay: timeStr, sortKey: fullTimestamp, isOTW: isOTW
                };
            });

            processed.sort((a, b) => {
                if (a.dateKey !== b.dateKey) return a.dateKey.localeCompare(b.dateKey);
                if (a.tipe !== b.tipe) return a.tipe.localeCompare(b.tipe);
                return a.sortKey.localeCompare(b.sortKey);
            });

            const groups = {};
            processed.forEach(item => {
                if (!groups[item.dateKey]) groups[item.dateKey] = {};
                if (!groups[item.dateKey][item.tipe]) groups[item.dateKey][item.tipe] = [];
                groups[item.dateKey][item.tipe].push(item);
            });

            resultArea.innerHTML = "";
            const sortedDates = Object.keys(groups).sort();

            sortedDates.forEach(date => {
                const dateSection = document.createElement("div");
                dateSection.className = "date-section";
                const pillClass = date.includes("Sedang Dalam") ? "date-header-pill otw" : "date-header-pill";
                dateSection.innerHTML = `<div class="${pillClass}">${date}</div>`;

                const typeGroups = groups[date];
                Object.keys(typeGroups).sort().forEach(type => {
                    const cars = typeGroups[type];
                    const group = document.createElement("div");
                    group.className = "shipping-group";
                    group.innerHTML = `<div class="shipping-header"><div class="shipping-title">${truckIcon} ${type}</div><div class="shipping-count">${cars.length}</div></div>`;
                    
                    const grid = document.createElement("div");
                    grid.className = "card-grid";

                    cars.forEach((car, idx) => {
                        const card = document.createElement("div");
                        const rank = idx + 1;
                        if (car.isOTW) {
                            card.className = "card is-otw";
                            card.innerHTML = `<div class="card-top"><span class="queue-label" style="color:#c2410c">Status</span><div class="otw-badge">OTW</div></div><div class="nopol">${car.nopol}</div><div class="card-footer"><div class="badge-type">${car.tipe}</div><div class="time-text" style="color:#c2410c">${truckIcon} Jalan</div></div>`;
                        } else {
                            card.className = "card";
                            card.innerHTML = `<div class="card-top"><span class="queue-label">Urutan</span><div class="rank-circle">${rank}</div></div><div class="nopol">${car.nopol}</div><div class="card-footer"><div class="badge-type">${car.tipe}</div><div class="time-text">${clockIcon} ${car.timeDisplay}</div></div>`;
                        }
                        grid.appendChild(card);
                    });
                    group.appendChild(grid);
                    dateSection.appendChild(group);
                });
                resultArea.appendChild(dateSection);
            });
        }
      });
    </script>
  </body>
</html>
